<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f0fff0">
  <title>Admin ‚Ä¢ Ntuconnect</title>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Inter','Segoe UI',Roboto,sans-serif;
      background:#ffffff;
      color:#2d5a2d;
      padding:18px;
    }
    header{
      background:#f0fff0;
      padding:1rem 2rem;
      border-radius:60px;
      margin-bottom:2rem;
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      gap:15px;
      box-shadow:0 2px 8px rgba(0,80,0,0.1);
      border:1px solid #2d5a2d;
    }
    header h2{color:#2d5a2d;font-weight:500;display:flex;align-items:center;gap:10px;}
    .card{
      background:#f8fff8;
      border-radius:36px;
      padding:26px;
      margin-bottom:28px;
      border:1px solid #2d5a2d;
      box-shadow:0 4px 12px rgba(0,80,0,0.05);
    }
    h3{
      color:#2d5a2d;
      margin-bottom:18px;
      font-size:1.5rem;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:2px solid #b0d2b0;
      padding-bottom:12px;
    }
    input,textarea,select,button{font-size:16px;}
    input,textarea,select{
      width:100%;
      padding:14px 18px;
      margin:8px 0;
      border-radius:50px;
      border:1px solid #2d5a2d;
      background:#ffffff;
      color:#2d5a2d;
    }
    input:focus,textarea:focus,select:focus{
      outline:none;
      border-color:#1e4a1e;
      box-shadow:0 0 0 3px rgba(45,90,45,0.2);
    }
    button{
      background:#2d5a2d;
      border:none;
      padding:12px 28px;
      border-radius:60px;
      color:white;
      font-weight:600;
      cursor:pointer;
      margin-right:8px;
      margin-bottom:8px;
      min-height:48px;
      transition:0.2s;
      border:1px solid rgba(0,80,0,0.2);
    }
    button:hover{background:#1e3e1e;}
    button.secondary{background:#e0f0e0;color:#2d5a2d;border:1px solid #2d5a2d;}
    button.secondary:hover{background:#c0e0c0;}
    .table-wrapper{overflow-x:auto;margin:20px 0;}
    table{width:100%;border-collapse:collapse;min-width:520px;}
    th,td{text-align:left;padding:14px 10px;border-bottom:1px solid #b0d2b0;}
    th{background:#e0f0e0;color:#2d5a2d;font-weight:500;}
    .admin-badge{background:#2d5a2d;color:white;padding:5px 12px;border-radius:40px;font-weight:600;}
    .user-badge{background:#e0f0e0;color:#2d5a2d;padding:5px 12px;border-radius:40px;}
    .message{padding:12px;border-radius:30px;margin:12px 0;display:none;}
    .success{background:#d0f0d0;color:#2d5a2d;display:block;}
    .error{background:#ffdddd;color:#8b0000;display:block;}
    .moderation-item{background:#f0fff0;border-radius:28px;padding:20px;margin:15px 0;border-left:6px solid #2d5a2d;word-break:break-word;}
    .moderation-meta{font-size:0.85rem;color:#4d7a4d;margin-bottom:10px;}
    .delete-btn{background:#b54a3f;padding:8px 20px;border-radius:30px;font-size:0.9rem;color:white;}
    .delete-btn:hover{background:#c45f54;}
    .tab-buttons{display:flex;gap:10px;margin-bottom:25px;flex-wrap:wrap;}
    .tab-btn{background:#e0f0e0;color:#2d5a2d;border:none;padding:12px 20px;border-radius:50px;cursor:pointer;font-size:0.95rem;transition:0.2s;border:1px solid #2d5a2d;}
    .tab-btn.active{background:#2d5a2d;color:white;font-weight:600;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    @media (max-width:480px){
      body{padding:12px;}
      header{flex-direction:column;text-align:center;}
      .card{padding:18px;}
      button{width:100%;margin-right:0;}
    }
  </style>
</head>
<body>
<header>
  <h2><i class="fa-solid fa-leaf" style="color:#2d5a2d;"></i> Dashboard</h2>
  <div><span id="userEmail" style="margin-right:15px; color:#2d5a2d;"></span><button onclick="logout()">Logout</button><button onclick="window.location='index.html'">‚Üê Community</button></div>
</header>
<div id="authCheck" style="display:none; text-align:center; padding:50px;"><h3>Checking authorization...</h3></div>
<div id="dashboard" style="display:none;">
  <div class="card">
    <h3><i class="fa-regular fa-calendar-plus"></i> Publish New Event</h3>
    <input type="text" id="eventTitle" placeholder="Event Title" required>
    <textarea id="eventDesc" placeholder="Description"></textarea>
    <input type="text" id="eventDate" placeholder="Date (e.g., March 15, 2025)">
    <input type="url" id="eventImage" placeholder="Image URL">
    <input type="url" id="eventVideo" placeholder="Video URL">
    <input type="url" id="eventAudio" placeholder="Audio URL">
    <button onclick="publishEvent()"><i class="fa-regular fa-calendar-check"></i> Publish Event</button>
    <div id="eventMessage" class="message"></div>
  </div>
  <div class="card">
    <h3><i class="fa-solid fa-key"></i> Change Password</h3>
    <input type="password" id="currentPass" placeholder="Current Password">
    <input type="password" id="newPass" placeholder="New Password">
    <input type="password" id="confirmNewPass" placeholder="Confirm New Password">
    <button onclick="changePassword()">Update Password</button>
    <div id="passMessage" class="message"></div>
  </div>
  <div class="card">
    <h3><i class="fa-solid fa-user-tie"></i> Manage Administrators</h3>
    <div class="table-wrapper"><table><thead><tr><th>Name</th><th>Email</th><th>Kindred</th><th>Role</th><th>Action</th></tr></thead><tbody id="userList"></tbody></table></div>
    <div id="adminMessage" class="message"></div>
  </div>
  <div class="card">
    <h3><i class="fa-solid fa-gavel"></i> Moderate Content</h3>
    <div class="tab-buttons"><button class="tab-btn active" data-tab="feed">Feed</button><button class="tab-btn" data-tab="chat">Chat</button><button class="tab-btn" data-tab="goodwill">Goodwill</button><button class="tab-btn" data-tab="live">Live Comments</button><button class="tab-btn" data-tab="replies">All Replies</button></div>
    <div id="tab-feed" class="tab-content active"><div id="moderateFeed"></div></div>
    <div id="tab-chat" class="tab-content"><div id="moderateChat"></div></div>
    <div id="tab-goodwill" class="tab-content"><div id="moderateGoodwill"></div></div>
    <div id="tab-live" class="tab-content"><div id="moderateLive"></div></div>
    <div id="tab-replies" class="tab-content"><div id="moderateReplies"></div></div>
  </div>
</div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDA02mVmQxC_cu2QCyq4NN8LhQIWo50V5A",
    authDomain: "ntudioka-online-c29d8.firebaseapp.com",
    projectId: "ntudioka-online-c29d8",
    storageBucket: "ntudioka-online-c29d8.firebasestorage.app",
    messagingSenderId: "1015621578149",
    appId: "1:1015621578149:web:c755b458e505fd32928c4c",
    measurementId: "G-JPVKYQRKEB"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const SUPER_ADMIN_EMAIL = "fintech.zubysworld@gmail.com";
  let currentUser = null;
  const authCheckDiv = document.getElementById('authCheck');
  const dashboardDiv = document.getElementById('dashboard');
  const userEmailSpan = document.getElementById('userEmail');

  function showError(err){alert("Error: "+err.message);console.error(err);}
  function showMessage(elId,text,type){const div=document.getElementById(elId);div.textContent=text;div.className=`message ${type}`;setTimeout(()=>{div.style.display='none';},5000);}

  auth.onAuthStateChanged(user=>{
    if(user){
      userEmailSpan.textContent=user.email;
      db.collection('users').doc(user.uid).get().then(doc=>{
        let isAdmin=doc.exists&&doc.data().isAdmin===true;
        if(!isAdmin&&user.email===SUPER_ADMIN_EMAIL){return db.collection('users').doc(user.uid).set({isAdmin:true},{merge:true}).then(()=>db.collection('users').doc(user.uid).get()).then(newDoc=>{isAdmin=newDoc.data().isAdmin;});}
      }).then(()=>db.collection('users').doc(user.uid).get()).then(doc=>{
        if(doc.exists&&doc.data().isAdmin===true){currentUser=user;authCheckDiv.style.display='none';dashboardDiv.style.display='block';loadUsers();loadAllContent();}
        else{authCheckDiv.innerHTML='<h3>Access Denied. You are not an administrator.</h3><button onclick="window.location=\'index.html\'">Go Home</button>';authCheckDiv.style.display='block';}
      }).catch(showError);
    }else{window.location.href='index.html';}
  });
  window.logout=function(){auth.signOut().then(()=>window.location.href='index.html').catch(showError);};

  function loadUsers(){
    db.collection('users').get().then(snapshot=>{const tbody=document.getElementById('userList');tbody.innerHTML='';snapshot.forEach(doc=>{const user=doc.data(),uid=doc.id,isAdmin=user.isAdmin||false;tbody.innerHTML+=`<tr><td>${user.name||'?'}</td><td>${user.email||'?'}</td><td>${user.kindred||'?'}</td><td><span class="${isAdmin?'admin-badge':'user-badge'}">${isAdmin?'ADMIN':'USER'}</span></td><td><button class="secondary" onclick="toggleAdmin('${uid}',${isAdmin})">${isAdmin?'Revoke':'Make Admin'}</button></td></tr>`;});}).catch(showError);
  }
  window.toggleAdmin=function(uid,currentStatus){if(!confirm(`Are you sure you want to ${currentStatus?'revoke admin from':'grant admin to'} this user?`))return;db.collection('users').doc(uid).update({isAdmin:!currentStatus}).then(()=>{showMessage('adminMessage','User role updated','success');loadUsers();}).catch(err=>showMessage('adminMessage',err.message,'error'));};

  window.publishEvent=function(){const title=document.getElementById('eventTitle').value.trim();if(!title)return showMessage('eventMessage','Title required','error');const data={title,created:Date.now(),description:document.getElementById('eventDesc').value.trim()||null,date:document.getElementById('eventDate').value.trim()||null,image:document.getElementById('eventImage').value.trim()||null,video:document.getElementById('eventVideo').value.trim()||null,audio:document.getElementById('eventAudio').value.trim()||null};db.collection('events').add(data).then(()=>{showMessage('eventMessage','Event published','success');['eventTitle','eventDesc','eventDate','eventImage','eventVideo','eventAudio'].forEach(id=>document.getElementById(id).value='');}).catch(err=>showMessage('eventMessage',err.message,'error'));};

  window.changePassword=function(){const curr=document.getElementById('currentPass').value;const newp=document.getElementById('newPass').value;const conf=document.getElementById('confirmNewPass').value;if(!curr||!newp||!conf)return showMessage('passMessage','All fields required','error');if(newp!==conf)return showMessage('passMessage','Passwords do not match','error');if(newp.length<6)return showMessage('passMessage','Password too short','error');const user=auth.currentUser;const cred=firebase.auth.EmailAuthProvider.credential(user.email,curr);user.reauthenticateWithCredential(cred).then(()=>user.updatePassword(newp)).then(()=>{showMessage('passMessage','Password updated','success');document.getElementById('currentPass').value=document.getElementById('newPass').value=document.getElementById('confirmNewPass').value='';}).catch(err=>showMessage('passMessage',err.message,'error'));};

  async function deleteDocumentAndSubcollections(docRef){const docSnap=await docRef.get();if(!docSnap.exists){console.log(`Document ${docRef.path} does not exist, skipping.`);return;}const collections=await docRef.listCollections();const deletionPromises=[];for(const subcol of collections){const snapshot=await subcol.get();snapshot.forEach(subDoc=>{deletionPromises.push(deleteDocumentAndSubcollections(subDoc.ref));});}await Promise.all(deletionPromises);await docRef.delete();console.log(`Deleted document: ${docRef.path}`);}
  window.deleteItem=function(path){if(!confirm('Permanently delete this item and all its replies?'))return;console.log(`Attempting to delete: ${path}`);const docRef=db.doc(path);deleteDocumentAndSubcollections(docRef).then(()=>alert('Deleted successfully')).catch(err=>{console.error('Delete error:',err);showError(err);});};

  function loadAllContent(){
    db.collection('feed').orderBy('created','desc').get().then(snap=>{const container=document.getElementById('moderateFeed');container.innerHTML='';snap.forEach(doc=>{const d=doc.data();container.innerHTML+=`<div class="moderation-item"><div class="moderation-meta">üì∞ Feed | ${d.name} (${d.kindred}) | ${new Date(d.created).toLocaleString()}</div><div>${d.text||''}</div><button class="delete-btn" onclick="deleteItem('feed/${doc.id}')"><i class="fa-regular fa-trash-can"></i> Delete</button></div>`;});}).catch(showError);
    db.collection('chat').orderBy('created','desc').get().then(snap=>{const container=document.getElementById('moderateChat');container.innerHTML='';snap.forEach(doc=>{const d=doc.data();container.innerHTML+=`<div class="moderation-item"><div class="moderation-meta">üí¨ Chat | ${d.name} (${d.kindred}) | ${new Date(d.created).toLocaleString()}</div><div>${d.text||''}</div><button class="delete-btn" onclick="deleteItem('chat/${doc.id}')">Delete</button></div>`;});}).catch(showError);
    db.collection('goodwill').orderBy('created','desc').get().then(snap=>{const container=document.getElementById('moderateGoodwill');container.innerHTML='';snap.forEach(doc=>{const d=doc.data();container.innerHTML+=`<div class="moderation-item"><div class="moderation-meta">ü§ù Goodwill | ${d.name} (${d.kindred}) | ${new Date(d.created).toLocaleString()}</div><div>${d.text||''}</div><button class="delete-btn" onclick="deleteItem('goodwill/${doc.id}')">Delete</button></div>`;});}).catch(showError);
    db.collection('live').doc('current').collection('comments').orderBy('created','desc').get().then(snap=>{const container=document.getElementById('moderateLive');container.innerHTML='';snap.forEach(doc=>{const d=doc.data();container.innerHTML+=`<div class="moderation-item"><div class="moderation-meta">üî¥ Live Comment | ${d.name} (${d.kindred}) | ${new Date(d.created).toLocaleString()}</div><div>${d.text||''}</div><button class="delete-btn" onclick="deleteItem('live/current/comments/${doc.id}')">Delete</button></div>`;});}).catch(showError);
    const replyContainer=document.getElementById('moderateReplies');replyContainer.innerHTML='';
    function loadRepliesForCollection(parentCol){return db.collection(parentCol).get().then(parentSnap=>{const promises=[];parentSnap.forEach(parentDoc=>{promises.push(parentDoc.ref.collection('replies').orderBy('created','desc').get().then(replySnap=>{replySnap.forEach(replyDoc=>{const r=replyDoc.data();replyContainer.innerHTML+=`<div class="moderation-item"><div class="moderation-meta">‚Ü≥ Reply in ${parentCol} | ${r.name} (${r.kindred}) | ${new Date(r.created).toLocaleString()}</div><div>${r.text||''}</div><button class="delete-btn" onclick="deleteItem('${parentCol}/${parentDoc.id}/replies/${replyDoc.id}')">Delete</button></div>`;}));}));});return Promise.all(promises);}
    Promise.all([loadRepliesForCollection('feed'),loadRepliesForCollection('chat'),loadRepliesForCollection('goodwill'),loadRepliesForCollection('live/current/comments')]).catch(showError);
  }
  document.querySelectorAll('.tab-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));document.getElementById('tab-'+btn.dataset.tab).classList.add('active');});});
</script>
</body>
</html>
