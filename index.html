<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ntuconnect</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        header { background: #4267B2; color: white; padding: 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; }
        nav ul { display: flex; list-style: none; gap: 1.5rem; }
        nav ul li a { color: white; text-decoration: none; font-weight: 500; cursor: pointer; }
        .user-section { display: flex; align-items: center; gap: 1rem; }
        .user-section button { background: white; color: #4267B2; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .user-section span { font-weight: 500; }
        main { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .post { border-bottom: 1px solid #ddd; padding: 1rem 0; }
        .post:last-child { border-bottom: none; }
        .post-meta { font-size: 0.9rem; color: #65676b; margin-bottom: 0.5rem; }
        .post-content { margin: 0.5rem 0; }
        .reactions { display: flex; gap: 0.5rem; margin: 0.5rem 0; }
        .reactions button { background: none; border: 1px solid #ccc; border-radius: 20px; padding: 0.3rem 1rem; cursor: pointer; transition: all 0.2s; }
        .reactions button:hover { background: #e0e0e0; }
        .reactions button.selected { background: #4267B2; color: white; border-color: #4267B2; }
        .comments-section { margin-top: 1rem; }
        .comment { background: #f0f2f5; border-radius: 18px; padding: 0.5rem 1rem; margin: 0.5rem 0; display: inline-block; max-width: 80%; }
        .comment small { color: #65676b; margin-left: 0.5rem; }
        .add-comment { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .add-comment input { flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 20px; }
        .add-comment button { background: #4267B2; color: white; border: none; border-radius: 20px; padding: 0.5rem 1rem; cursor: pointer; }
        .podcast-player { background: #1e1e1e; color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .podcast-controls { display: flex; align-items: center; gap: 1rem; margin: 1rem 0; }
        .podcast-controls button { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .playlist-item { display: flex; align-items: center; gap: 1rem; padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #333; }
        .playlist-item:hover { background: #333; }
        .spotify-player { background: #191414; color: #1DB954; padding: 1rem; border-radius: 8px; }
        .live-broadcast iframe { width: 100%; height: 400px; border: none; border-radius: 8px; }
        .admin-form input, .admin-form select, .admin-form textarea { width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 5px; }
        .admin-form button { background: #4267B2; color: white; border: none; padding: 0.7rem; border-radius: 5px; cursor: pointer; }
        .error { color: #c00; background: #ffe6e6; padding: 0.5rem; border-radius: 5px; margin: 0.5rem 0; }
        .success { color: #0a0; background: #e6ffe6; padding: 0.5rem; border-radius: 5px; margin: 0.5rem 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <div class="logo">Ntuconnect</div>
        <nav>
            <ul>
                <li><a onclick="showTab('home')">Home</a></li>
                <li><a onclick="showTab('podcasts')">Podcasts</a></li>
                <li><a onclick="showTab('live')">Live</a></li>
                <li><a onclick="showTab('spotify')">Spotify</a></li>
                <li id="admin-tab" class="hidden"><a onclick="showTab('admin')">Admin</a></li>
            </ul>
        </nav>
        <div class="user-section">
            <span id="userDisplay"></span>
            <button id="loginBtn" onclick="showLoginModal()">Login</button>
            <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Login Modal (simple inline for demo) -->
    <div id="loginModal" class="hidden" style="position: fixed; top: 20%; left: 50%; transform: translate(-50%, -20%); background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000;">
        <h3>Login / Register</h3>
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="text" id="loginName" placeholder="Your name">
        <button onclick="login()">Continue</button>
        <button onclick="hideLoginModal()">Cancel</button>
        <p class="error" id="loginError"></p>
    </div>
    <div id="overlay" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5; z-index:999;" onclick="hideLoginModal()"></div>

    <main>
        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <div class="card">
                <h2>Feed</h2>
                <div id="feed"></div>
            </div>
        </div>

        <!-- Podcasts Tab -->
        <div id="podcasts" class="tab-content">
            <div class="card">
                <h2>Podcasts</h2>
                <div class="podcast-player" id="podcastPlayer">
                    <audio id="audioPlayer" controls style="width:100%"></audio>
                    <div class="podcast-controls">
                        <button onclick="playPrev()"><i class="fas fa-step-backward"></i></button>
                        <button onclick="playPause()"><i class="fas fa-play" id="playPauseIcon"></i></button>
                        <button onclick="playNext()"><i class="fas fa-step-forward"></i></button>
                        <select id="repeatMode" onchange="setRepeatMode(this.value)">
                            <option value="none">No repeat</option>
                            <option value="one">Repeat one</option>
                            <option value="all">Repeat all</option>
                        </select>
                        <button onclick="toggleLoop()" id="loopBtn"><i class="fas fa-redo"></i></button>
                    </div>
                    <div id="currentPodcastInfo"></div>
                </div>
                <div>
                    <h3>Episodes</h3>
                    <div id="podcastList"></div>
                </div>
                <div>
                    <h3>My Playlists</h3>
                    <div id="playlistList"></div>
                    <button onclick="createPlaylist()" id="createPlaylistBtn" class="hidden">+ New Playlist</button>
                </div>
            </div>
        </div>

        <!-- Live Tab -->
        <div id="live" class="tab-content">
            <div class="card">
                <h2>Live Broadcasts</h2>
                <div id="liveList"></div>
            </div>
        </div>

        <!-- Spotify Tab -->
        <div id="spotify" class="tab-content">
            <div class="card spotify-player">
                <h2>Spotify Streaming</h2>
                <div id="spotifyStatus"></div>
                <div id="spotifyPlayer"></div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <div class="card admin-form">
                <h2>Admin Panel</h2>
                <h3>Create New Post</h3>
                <select id="postType">
                    <option value="goodwill">Goodwill Message</option>
                    <option value="event">Event</option>
                    <option value="podcast">Podcast</option>
                    <option value="live">Live Broadcast</option>
                </select>
                <input type="text" id="postTitle" placeholder="Title (optional for goodwill)">
                <textarea id="postContent" placeholder="Content"></textarea>
                <input type="text" id="postMediaURL" placeholder="Media URL (for podcast: Google Drive file ID)">
                <input type="datetime-local" id="postScheduled" placeholder="Scheduled time (for events/live)">
                <button onclick="createPost()">Publish</button>
                <div id="adminMessage"></div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyIfbX_CVhakdvVMFrXnqx_zWCpmk3xgFHd3yKxmJ8X3jmQaQx_h7GcIiOQdddusDKxfg/exec';
        const SPOTIFY_CLIENT_ID = 'd656dc4a92b24ff39bce8bc8f2e29add';
        const YOUTUBE_API_KEY = 'AIzaSyA2GQxMOE3ll4rS4-rQdFPWKc8tZt6SedY';

        // Global state
        let currentUser = null;
        let allPodcasts = [];
        let currentPlaylist = [];         // list of podcast IDs in current playlist
        let currentIndex = 0;
        let repeatMode = 'none';           // 'none', 'one', 'all'
        let loop = false;
        let spotifyPlayer = null;
        let spotifyDeviceId = null;

        // ==================== INITIALIZATION ====================
        window.onload = async function() {
            // Load user from localStorage
            const stored = localStorage.getItem('ntuconnect_user');
            if (stored) {
                currentUser = JSON.parse(stored);
                updateUserUI();
                // Check if user is admin
                await checkAdminStatus();
            }
            // Load initial data
            loadFeed();
            loadPodcasts();
            loadLiveBroadcasts();
            loadFeatures();
            // Setup Spotify SDK
            window.onSpotifyWebPlaybackSDKReady = initSpotifyPlayer;
        };

        // ==================== UI HELPERS ====================
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('overlay').classList.remove('hidden');
        }
        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const name = document.getElementById('loginName').value.trim() || 'User';
            if (!email) {
                document.getElementById('loginError').textContent = 'Email is required';
                return;
            }
            document.getElementById('loginError').textContent = '';

            // Register/login via Apps Script
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'ensureUser', userEmail: email, userName: name })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                currentUser = { email, name, role: data.role || 'user' };
                localStorage.setItem('ntuconnect_user', JSON.stringify(currentUser));
                updateUserUI();
                hideLoginModal();
                await checkAdminStatus();
                loadFeed(); // refresh to enable interactions
            } catch (err) {
                document.getElementById('loginError').textContent = err.message;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('ntuconnect_user');
            updateUserUI();
            document.getElementById('admin-tab').classList.add('hidden');
            showTab('home');
            loadFeed(); // refresh to view-only mode
        }

        function updateUserUI() {
            const userSpan = document.getElementById('userDisplay');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            if (currentUser) {
                userSpan.textContent = `Hi, ${currentUser.name || currentUser.email}`;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                userSpan.textContent = '';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        async function checkAdminStatus() {
            if (!currentUser) return;
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getUserRole&email=${encodeURIComponent(currentUser.email)}`);
                const data = await resp.json();
                if (data.role === 'admin') {
                    document.getElementById('admin-tab').classList.remove('hidden');
                    currentUser.role = 'admin';
                } else {
                    document.getElementById('admin-tab').classList.add('hidden');
                }
            } catch (err) {
                console.error('Failed to check admin status', err);
            }
        }

        // ==================== FEED ====================
        async function loadFeed() {
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getPosts`);
                const data = await resp.json();
                displayFeed(data.posts || []);
            } catch (err) {
                document.getElementById('feed').innerHTML = `<p class="error">Failed to load feed: ${err.message}</p>`;
            }
        }

        function displayFeed(posts) {
            const feedDiv = document.getElementById('feed');
            if (posts.length === 0) {
                feedDiv.innerHTML = '<p>No posts yet.</p>';
                return;
            }
            let html = '';
            posts.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            posts.forEach(post => {
                html += `
                    <div class="post" data-postid="${post.postID}">
                        <div class="post-meta">
                            <strong>${post.createdBy}</strong> ¬∑ ${new Date(post.timestamp).toLocaleString()}
                            ${post.type ? ` ¬∑ <span class="badge">${post.type}</span>` : ''}
                        </div>
                        ${post.title ? `<h3>${post.title}</h3>` : ''}
                        <div class="post-content">${post.content || ''}</div>
                        ${post.mediaURL ? `<p><a href="${post.mediaURL}" target="_blank">üîó Media</a></p>` : ''}
                        <div class="reactions" id="reactions-${post.postID}">
                            <button onclick="react('${post.postID}', 'like')" ${!currentUser ? 'disabled' : ''}>üëç Like</button>
                            <button onclick="react('${post.postID}', 'love')" ${!currentUser ? 'disabled' : ''}>‚ù§Ô∏è Love</button>
                            <button onclick="react('${post.postID}', 'hate')" ${!currentUser ? 'disabled' : ''}>üëé Hate</button>
                            <button onclick="react('${post.postID}', 'angry')" ${!currentUser ? 'disabled' : ''}>üò† Angry</button>
                        </div>
                        <div class="comments-section" id="comments-${post.postID}"></div>
                        ${currentUser ? `
                            <div class="add-comment">
                                <input type="text" id="comment-input-${post.postID}" placeholder="Write a comment...">
                                <button onclick="addComment('${post.postID}')">Post</button>
                            </div>
                        ` : '<p><em>Login to comment</em></p>'}
                    </div>
                `;
            });
            feedDiv.innerHTML = html;
            // Load comments and reactions for each post
            posts.forEach(post => {
                loadComments(post.postID);
                loadReactions(post.postID, 'post');
            });
        }

        async function react(targetID, type) {
            if (!currentUser) { alert('Please login first'); return; }
            try {
                const resp = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'addReaction',
                        userEmail: currentUser.email,
                        targetID,
                        targetType: 'post',
                        reactionType: type
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error);
                loadReactions(targetID, 'post');
            } catch (err) {
                alert('Reaction failed: ' + err.message);
            }
        }

        async function loadReactions(targetID, targetType) {
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getReactions&targetID=${targetID}&targetType=${targetType}`);
                const data = await resp.json();
                // Update button states (optional)
            } catch (err) {
                console.error(err);
            }
        }

        async function addComment(postID) {
            const input = document.getElementById(`comment-input-${postID}`);
            const text = input.value.trim();
            if (!text) return;
            try {
                const resp = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'addComment',
                        userEmail: currentUser.email,
                        postID,
                        comment: text
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error);
                input.value = '';
                loadComments(postID);
            } catch (err) {
                alert('Comment failed: ' + err.message);
            }
        }

        async function loadComments(postID) {
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getComments&postID=${postID}`);
                const data = await resp.json();
                const commentsDiv = document.getElementById(`comments-${postID}`);
                if (!commentsDiv) return;
                if (data.comments && data.comments.length) {
                    let html = '<h4>Comments</h4>';
                    data.comments.forEach(c => {
                        html += `<div class="comment"><strong>${c.userID}</strong> ${c.comment} <small>${new Date(c.timestamp).toLocaleString()}</small></div>`;
                    });
                    commentsDiv.innerHTML = html;
                } else {
                    commentsDiv.innerHTML = '<p><em>No comments yet.</em></p>';
                }
            } catch (err) {
                console.error(err);
            }
        }

        // ==================== PODCASTS ====================
        async function loadPodcasts() {
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getPodcasts`);
                const data = await resp.json();
                allPodcasts = data.podcasts || [];
                renderPodcastList();
                loadUserPlaylists();
            } catch (err) {
                console.error('Failed to load podcasts', err);
            }
        }

        function renderPodcastList() {
            const listDiv = document.getElementById('podcastList');
            if (allPodcasts.length === 0) {
                listDiv.innerHTML = '<p>No podcasts available.</p>';
                return;
            }
            let html = '';
            allPodcasts.forEach((pod, idx) => {
                html += `<div class="playlist-item" onclick="playPodcast(${idx})">
                    <i class="fas fa-headphones"></i>
                    <div><strong>${pod.title}</strong><br><small>${pod.description || ''}</small></div>
                </div>`;
            });
            listDiv.innerHTML = html;
        }

        function playPodcast(index) {
            if (!allPodcasts.length) return;
            currentPlaylist = allPodcasts.map(p => p.podcastID);
            currentIndex = index;
            loadAndPlay(currentIndex);
        }

        function loadAndPlay(index) {
            const podcast = allPodcasts.find(p => p.podcastID === currentPlaylist[index]);
            if (!podcast) return;
            const audio = document.getElementById('audioPlayer');
            // Construct Google Drive direct link from file ID
            const fileId = podcast.audioFileID;
            const url = `https://drive.google.com/uc?export=download&id=${fileId}`;
            audio.src = url;
            audio.play();
            document.getElementById('currentPodcastInfo').innerHTML = `<strong>Now playing:</strong> ${podcast.title}`;
        }

        function playNext() {
            if (!currentPlaylist.length) return;
            if (repeatMode === 'one') {
                loadAndPlay(currentIndex);
                return;
            }
            let nextIndex = currentIndex + 1;
            if (nextIndex >= currentPlaylist.length) {
                if (repeatMode === 'all' || loop) {
                    nextIndex = 0;
                } else {
                    return; // stop
                }
            }
            currentIndex = nextIndex;
            loadAndPlay(currentIndex);
        }

        function playPrev() {
            if (!currentPlaylist.length) return;
            let prevIndex = currentIndex - 1;
            if (prevIndex < 0) {
                if (repeatMode === 'all' || loop) {
                    prevIndex = currentPlaylist.length - 1;
                } else {
                    return;
                }
            }
            currentIndex = prevIndex;
            loadAndPlay(currentIndex);
        }

        function playPause() {
            const audio = document.getElementById('audioPlayer');
            const icon = document.getElementById('playPauseIcon');
            if (audio.paused) {
                audio.play();
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            } else {
                audio.pause();
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            }
        }

        function setRepeatMode(mode) {
            repeatMode = mode;
        }

        function toggleLoop() {
            loop = !loop;
            document.getElementById('loopBtn').style.color = loop ? '#1DB954' : 'white';
        }

        // Set up audio ended listener
        document.getElementById('audioPlayer').addEventListener('ended', function() {
            playNext();
        });

        // Playlist management
        async function loadUserPlaylists() {
            if (!currentUser) return;
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getPlaylists&userID=${encodeURIComponent(currentUser.email)}`);
                const data = await resp.json();
                renderPlaylists(data.playlists || []);
            } catch (err) {
                console.error(err);
            }
        }

        function renderPlaylists(playlists) {
            const listDiv = document.getElementById('playlistList');
            if (playlists.length === 0) {
                listDiv.innerHTML = '<p>No playlists yet.</p>';
            } else {
                let html = '';
                playlists.forEach(pl => {
                    html += `<div class="playlist-item" onclick="loadPlaylist('${pl.playlistID}')">
                        <i class="fas fa-list"></i> ${pl.name}
                    </div>`;
                });
                listDiv.innerHTML = html;
            }
            document.getElementById('createPlaylistBtn').classList.toggle('hidden', !currentUser);
        }

        function createPlaylist() {
            const name = prompt('Enter playlist name:');
            if (!name) return;
            // For simplicity, create empty playlist. User can add episodes later.
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'createPlaylist',
                    userEmail: currentUser.email,
                    name: name,
                    podcastIDs: []
                })
            }).then(() => loadUserPlaylists());
        }

        function loadPlaylist(playlistID) {
            // Fetch playlist details and set currentPlaylist
            // For brevity, we'll just alert.
            alert('Load playlist ' + playlistID);
        }

        // ==================== LIVE BROADCASTS ====================
        async function loadLiveBroadcasts() {
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getLiveBroadcasts`);
                const data = await resp.json();
                renderLiveBroadcasts(data.broadcasts || []);
            } catch (err) {
                console.error(err);
            }
        }

        function renderLiveBroadcasts(broadcasts) {
            const liveDiv = document.getElementById('liveList');
            if (broadcasts.length === 0) {
                liveDiv.innerHTML = '<p>No live broadcasts scheduled.</p>';
                return;
            }
            let html = '';
            broadcasts.forEach(b => {
                html += `<div class="card">
                    <h3>${b.title}</h3>
                    <p>${b.description || ''}</p>
                    <p><strong>Scheduled:</strong> ${new Date(b.scheduledTime).toLocaleString()}</p>
                    <p><strong>Status:</strong> ${b.status}</p>
                    ${b.youtubeURL ? `<div class="live-broadcast"><iframe src="https://www.youtube.com/embed/${extractVideoId(b.youtubeURL)}?autoplay=1" allowfullscreen></iframe></div>` : ''}
                </div>`;
            });
            liveDiv.innerHTML = html;
        }

        function extractVideoId(url) {
            const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=))([^?&]+)/);
            return match ? match[1] : '';
        }

        // ==================== SPOTIFY ====================
        function initSpotifyPlayer() {
            if (!currentUser) return;
            // Get user's Spotify token from backend
            fetch(`${APPS_SCRIPT_URL}?action=getSpotifyToken&userID=${encodeURIComponent(currentUser.email)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.token) {
                        setupSpotifyPlayer(data.token.accessToken);
                    } else {
                        document.getElementById('spotifyStatus').innerHTML = '<p>Link your Spotify account <button onclick="spotifyLogin()">here</button></p>';
                    }
                });
        }

        function spotifyLogin() {
            window.location.href = `${APPS_SCRIPT_URL}?action=spotifyAuth`;
        }

        function setupSpotifyPlayer(token) {
            const player = new Spotify.Player({
                name: 'Ntuconnect Player',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });
            player.addListener('ready', ({ device_id }) => {
                console.log('Spotify player ready', device_id);
                spotifyDeviceId = device_id;
                document.getElementById('spotifyStatus').innerHTML = '<p>Spotify player ready. Use controls above.</p>';
                // Add playback controls
                document.getElementById('spotifyPlayer').innerHTML = `
                    <button onclick="spotifyPlay()">Play</button>
                    <button onclick="spotifyPause()">Pause</button>
                    <button onclick="spotifyNext()">Next</button>
                    <button onclick="spotifyPrevious()">Prev</button>
                `;
            });
            player.connect();
            spotifyPlayer = player;
        }

        function spotifyPlay() { spotifyPlayer?.resume(); }
        function spotifyPause() { spotifyPlayer?.pause(); }
        function spotifyNext() { spotifyPlayer?.nextTrack(); }
        function spotifyPrevious() { spotifyPlayer?.previousTrack(); }

        // ==================== ADMIN ====================
        async function createPost() {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Admin only');
                return;
            }
            const type = document.getElementById('postType').value;
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const mediaURL = document.getElementById('postMediaURL').value;
            const scheduled = document.getElementById('postScheduled').value;

            const payload = {
                action: 'createPost',
                userEmail: currentUser.email,
                type,
                title,
                content,
                mediaURL,
                scheduledFor: scheduled
            };
            try {
                const resp = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error);
                document.getElementById('adminMessage').innerHTML = '<p class="success">Post created!</p>';
                // Clear form
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                document.getElementById('postMediaURL').value = '';
                document.getElementById('postScheduled').value = '';
            } catch (err) {
                document.getElementById('adminMessage').innerHTML = `<p class="error">${err.message}</p>`;
            }
        }

        // ==================== DYNAMIC FEATURES ====================
        async function loadFeatures() {
            try {
                const resp = await fetch(`${APPS_SCRIPT_URL}?action=getFeatures`);
                const data = await resp.json();
                // Dynamically add buttons to nav (example)
                if (data.features) {
                    const navUl = document.querySelector('nav ul');
                    data.features.forEach(f => {
                        if (f.featureType === 'button' || f.featureType === 'link') {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${f.url}" target="${f.url.startsWith('http') ? '_blank' : ''}">${f.name}</a>`;
                            navUl.appendChild(li);
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load features', err);
            }
        }
    </script>
</body>
</html>
